<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Semantic Video Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        input {
            width: 400px;
            padding: 8px;
        }

        button {
            padding: 8px 12px;
            margin-left: 5px;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <div style="background:#f0f0f0; padding:15px; margin-bottom:20px; border-radius:8px;">
        <h3>üîÑ Switch Video Source</h3>
        <input id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." style="width:300px" />
        <button id="loadBtn" onclick="processVideo()">Load Video</button>
        <div id="status" style="margin-top:10px; font-weight:bold; color:#555;"></div>
    </div>

    <h2>üé¨ Semantic Video Search</h2>

    <input id="query" placeholder="before crowd celebrating" />
    <button onclick="search()">Search</button>

    <div id="results"></div>

    <div style="margin-top: 40px; padding: 20px; background: #e8f4f8; border-radius: 8px; border: 2px solid #4a90e2;">
        <h3>ü§ñ RAG-Enhanced Search (with AI explanations)</h3>
        <p style="color: #555; font-size: 14px;">Get intelligent explanations, suggestions, and summaries of your search results</p>
        <input id="ragQuery" placeholder="hesitant reaction before answering" style="width:400px; padding:8px;" />
        <button onclick="ragSearch()" style="padding:8px 12px; margin-left:5px; background:#4a90e2; color:white; border:none; border-radius:4px; cursor:pointer;">RAG Search</button>
        <div id="ragResults" style="margin-top:15px;"></div>
    </div>

    <script>
        async function processVideo() {
            const url = document.getElementById("videoUrl").value;
            if (!url) return alert("Please enter a URL");

            document.getElementById("loadBtn").disabled = true;
            document.getElementById("status").innerText = "Requesting...";

            try {
                await fetch("http://localhost:8000/process-video", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url })
                });

                pollStatus();

            } catch (err) {
                document.getElementById("status").innerText = "Error starting job";
                document.getElementById("loadBtn").disabled = false;
            }
        }

        async function pollStatus() {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch("http://localhost:8000/process-status");
                    const data = await res.json();

                    document.getElementById("status").innerText = "Status: " + data.message;

                    if (data.state === "completed" || data.state === "error") {
                        clearInterval(interval);
                        document.getElementById("loadBtn").disabled = false;
                        if (data.state === "completed") {
                            alert("Video processed! You can now search.");
                        }
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 2000);
        }

        async function search() {
            const query = document.getElementById("query").value;
            document.getElementById("results").innerHTML = "Searching...";

            try {
                const response = await fetch(
                    `http://localhost:8000/intent-search?query=${encodeURIComponent(query)}`,
                    { method: "POST" }
                );

                const data = await response.json();

                let html = "";
                data.forEach(item => {
                    html += `
                  <div style="margin-bottom:15px">
                      <b>Best Frame:</b> ${item.best_frame}<br>
                      <img src="http://localhost:8000/frames/${item.best_frame}" style="width:200px; border:1px solid #ddd; margin-top:5px;" /><br>
                      <b>Caption:</b> ${item.caption}<br>
                      <b>Score:</b> ${item.score.toFixed(3)}<br>
                      <b>Intent:</b> ${item.intent}<br>
                      <b>Time Range:</b> ${item.start}s - ${item.end}s<br>
                      <video width="320" height="240" controls preload="metadata">
                          <source src="${item.video_url}" type="video/mp4">
                          Your browser does not support the video tag.
                      </video><br>
                      <a href="${item.full_video_url}" target="_blank" style="text-decoration:none; font-size:14px;">üîó Jump to time in full video</a>
                  </div>
                  <hr>
              `;
                });

                document.getElementById("results").innerHTML = html;

            } catch (err) {
                document.getElementById("results").innerHTML =
                    "‚ùå Error connecting to backend";
                console.error(err);
            }
        }

        async function ragSearch() {
            const query = document.getElementById("ragQuery").value;
            if (!query) {
                alert("Please enter a search query");
                return;
            }
            
            document.getElementById("ragResults").innerHTML = "<p>Searching with AI...</p>";

            try {
                const response = await fetch(
                    `http://localhost:8000/rag-search?query=${encodeURIComponent(query)}`,
                    { method: "POST" }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                let html = `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="color: #4a90e2; margin-top:0;">üí° AI Explanation:</h4>
                        <p style="line-height: 1.6;">${data.explanation || "No explanation available."}</p>
                        
                        <h4 style="color: #4a90e2;">üìä Summary:</h4>
                        <p style="line-height: 1.6;">${data.summary || "No summary available."}</p>
                        
                        <h4 style="color: #4a90e2;">üí° Suggested Queries:</h4>
                        <ul style="line-height: 1.8;">
                            ${(data.suggestions || []).map(s => `<li style="cursor:pointer; color:#4a90e2;" onclick="document.getElementById('ragQuery').value='${s.replace(/'/g, "\\'")}'; ragSearch();">${s}</li>`).join('')}
                        </ul>
                    </div>
                `;

                if (data.results && data.results.length > 0) {
                    html += `<h4 style="color: #4a90e2;">üé¨ Found ${data.count} matching video clips:</h4>`;
                    data.results.forEach((item, index) => {
                        html += `
                            <div style="margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:5px; background:white;">
                                <div style="display:flex; gap:15px;">
                                    <div style="flex:1;">
                                        <b>Match ${index + 1}:</b> ${item.caption}<br>
                                        <b>Relevance Score:</b> ${item.score.toFixed(3)}<br>
                                        <b>Intent:</b> ${item.intent}<br>
                                        <b>Time Range:</b> ${item.start.toFixed(1)}s - ${item.end.toFixed(1)}s<br>
                                        <img src="http://localhost:8000/frames/${item.best_frame}" 
                                             style="width:200px; margin-top:10px; border:1px solid #ddd; border-radius:4px;" 
                                             onerror="this.style.display='none';" /><br>
                                        <a href="${item.full_video_url}" target="_blank" 
                                           style="text-decoration:none; color:#4a90e2; font-size:14px; margin-top:10px; display:inline-block;">
                                            üîó Jump to time in full video
                                        </a>
                                    </div>
                                    <div style="flex:1;">
                                        <video width="320" height="240" controls style="border-radius:4px;">
                                            <source src="${item.video_url}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p style="color: #d32f2f;">No matching video clips found. Try the suggested queries above or rephrase your search.</p>`;
                }

                document.getElementById("ragResults").innerHTML = html;

            } catch (err) {
                document.getElementById("ragResults").innerHTML = 
                    `<div style="background:#ffebee; padding:15px; border-radius:5px; color:#d32f2f;">
                        <strong>‚ùå Error:</strong> ${err.message}<br>
                        <small>Make sure the backend is running and RAG is properly configured.</small>
                    </div>`;
                console.error(err);
            }
        }
    </script>






</body>

</html>